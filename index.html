import React, { useState } from 'react';
import { Send, Heart } from 'lucide-react';

export default function VentRelax() {
  const [ventText, setVentText] = useState('');
  const [response, setResponse] = useState(null);
  const [loading, setLoading] = useState(false);

  const relaxationActions = [
    "Before you scroll away, place one hand on your chest, take 3 slow breaths, and just notice it rising and falling.",
    "Unclench your jaw, lower your shoulders, and gently roll them back 3 times.",
    "Look around and quietly name 3 things you can see and 2 things you can hear. Let your mind anchor to the present for a moment.",
    "Close your eyes for 30 seconds and imagine a place where you felt completely safe and at peace.",
    "Stand up, stretch your arms up high, and take one deep breath. Then slowly release and let your arms fall.",
    "Press your feet firmly into the ground and notice the support beneath you for a few moments.",
    "Cup your hands over your eyes and rest in darkness for 5 slow breaths.",
    "Gently shake out your hands for 10 seconds, releasing any tension you're holding."
  ];

  const getCrisisKeywords = (text) => {
    const lowerText = text.toLowerCase();
    const crisisWords = ['kill myself', 'suicide', 'end my life', 'want to die', 'harm myself', 'hurt myself'];
    return crisisWords.some(word => lowerText.includes(word));
  };

  const handleSubmit = async () => {
    if (!ventText.trim()) return;

    setLoading(true);
    
    // Check for crisis content
    if (getCrisisKeywords(ventText)) {
      setResponse({
        empathy: "I hear that you're in a really dark place right now, and I want you to know that your pain is real. But this is beyond what this space can offer.",
        action: "Please reach out to someone who can truly help: call a crisis hotline, text a crisis line, or go to your nearest emergency room. You deserve real support right now.",
        isCrisis: true
      });
      setLoading(false);
      return;
    }

    try {
      const apiResponse = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 1000,
          messages: [
            {
              role: "user",
              content: `You are a compassionate, non-judgmental listener for an anonymous venting platform. A person has shared the following:

"${ventText}"

Respond with:
1. A SHORT empathetic reflection (1-3 sentences) that validates their feelings and normalizes their struggle. Be warm and understanding, never clinical or preachy. Never give advice about life decisions.
2. Keep it brief and digestible - people are tired.

Format your response as plain text, starting with the empathetic reflection. Do not include any labels, headers, or formatting markers.`
            }
          ],
        })
      });

      const data = await apiResponse.json();
      const empathyText = data.content
        .filter(item => item.type === "text")
        .map(item => item.text)
        .join("\n")
        .trim();

      const randomAction = relaxationActions[Math.floor(Math.random() * relaxationActions.length)];

      setResponse({
        empathy: empathyText,
        action: randomAction,
        isCrisis: false
      });
    } catch (error) {
      setResponse({
        empathy: "It sounds like you're carrying something heavy right now. That weight is real, and it makes complete sense that you needed to put it into words.",
        action: relaxationActions[0],
        isCrisis: false
      });
    }

    setLoading(false);
  };

  const handleReset = () => {
    setVentText('');
    setResponse(null);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
      <div className="max-w-2xl w-full">
        {!response ? (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl p-8 md:p-12">
            <div className="text-center mb-8">
              <div className="inline-block p-3 bg-purple-100 rounded-full mb-4">
                <Heart className="w-8 h-8 text-purple-600" />
              </div>
              <h1 className="text-4xl md:text-5xl font-bold text-gray-800 mb-3">
                Write it out. Let it go.
              </h1>
              <p className="text-gray-600 text-lg">
                No account. No tracking. Just a space to unload your thoughts.
              </p>
            </div>

            <div className="mb-6">
              <textarea
                value={ventText}
                onChange={(e) => setVentText(e.target.value)}
                placeholder="What's weighing on you today?"
                className="w-full h-64 p-6 text-lg border-2 border-purple-200 rounded-2xl focus:outline-none focus:border-purple-400 resize-none bg-white/50 placeholder-gray-400"
                disabled={loading}
              />
            </div>

            <button
              onClick={handleSubmit}
              disabled={!ventText.trim() || loading}
              className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 px-8 rounded-2xl font-semibold text-lg flex items-center justify-center gap-3 hover:from-purple-600 hover:to-pink-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl"
            >
              {loading ? (
                <span>Listening...</span>
              ) : (
                <>
                  <Send className="w-5 h-5" />
                  Send & get a gentle response
                </>
              )}
            </button>

            <div className="mt-8 text-center text-sm text-gray-500 border-t border-gray-200 pt-6">
              <p className="mb-2">
                <strong>This is not a crisis service or therapy.</strong>
              </p>
              <p>
                If you're in danger or thinking of harming yourself, please contact local emergency or crisis services immediately.
              </p>
            </div>
          </div>
        ) : (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl p-8 md:p-12">
            <div className="text-center mb-8">
              <div className="inline-block p-3 bg-green-100 rounded-full mb-4">
                <Heart className="w-8 h-8 text-green-600" />
              </div>
              <h2 className="text-3xl font-bold text-gray-800 mb-2">
                {response.isCrisis ? "Please seek help" : "You've been heard"}
              </h2>
            </div>

            <div className={`mb-8 p-6 ${response.isCrisis ? 'bg-red-50 border-2 border-red-200' : 'bg-purple-50 border-2 border-purple-200'} rounded-2xl`}>
              <p className="text-gray-700 text-lg leading-relaxed mb-4">
                {response.empathy}
              </p>
              <div className={`mt-6 pt-6 border-t ${response.isCrisis ? 'border-red-200' : 'border-purple-200'}`}>
                <p className="text-gray-600 italic">
                  {response.action}
                </p>
              </div>
            </div>

            <button
              onClick={handleReset}
              className="w-full bg-gray-100 text-gray-700 py-4 px-8 rounded-2xl font-semibold text-lg hover:bg-gray-200 transition-all"
            >
              Write something else
            </button>

            <div className="mt-8 text-center text-sm text-gray-500">
              <p>Take care of yourself. You deserve gentleness.</p>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
